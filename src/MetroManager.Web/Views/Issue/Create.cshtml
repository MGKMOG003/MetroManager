@model MetroManager.Web.ViewModels.IssueCreateVm
@using System.Text.Json

@{
    ViewData["Title"] = "Report an Issue";
    var subMapJson = JsonSerializer.Serialize(Model.CategorySubcategories);
}

<h2 class="mb-3">Report an Issue</h2>

<form id="issueForm" asp-action="Create" method="post" enctype="multipart/form-data">
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

    <div class="mb-3">
        <label class="form-label" asp-for="Title"></label>
        <input class="form-control" asp-for="Title" />
        <span class="text-danger" asp-validation-for="Title"></span>
    </div>

    <div class="mb-3">
        <label class="form-label" asp-for="Description"></label>
        <textarea class="form-control" asp-for="Description" rows="5"></textarea>
        <span class="text-danger" asp-validation-for="Description"></span>
    </div>

    <div class="row g-3">
        <div class="col-md-6">
            <label class="form-label" asp-for="Category"></label>
            <select class="form-select" asp-for="Category" id="Category"
                    asp-items="@(new SelectList(Model.Categories))"></select>
            <span class="text-danger" asp-validation-for="Category"></span>
        </div>

        <div class="col-md-6">
            <label class="form-label" asp-for="Subcategory"></label>
            <select class="form-select" asp-for="Subcategory" id="Subcategory">
                <option value="">-- Select subcategory --</option>
            </select>
            <span class="text-danger" asp-validation-for="Subcategory"></span>
        </div>
    </div>

    <div class="mb-3 mt-2">
        <label class="form-label" asp-for="OtherCategory"></label>
        <input class="form-control" asp-for="OtherCategory" id="OtherCategory" disabled />
        <div class="form-text">Enabled only when “Other” is the main category.</div>
        <span class="text-danger" asp-validation-for="OtherCategory"></span>
    </div>

    <div class="row g-3">
        <div class="col-md-6">
            <label class="form-label" asp-for="LocationText"></label>
            <input class="form-control" asp-for="LocationText" />
            <span class="text-danger" asp-validation-for="LocationText"></span>
        </div>
        <div class="col-md-6">
            <label class="form-label" asp-for="LocationLink"></label>
            <input class="form-control" asp-for="LocationLink" placeholder="https://maps.google.com/?q=..." />
            <span class="text-danger" asp-validation-for="LocationLink"></span>
        </div>
    </div>

    <div class="mb-3 mt-3">
        <label class="form-label">Photos / files</label>
        <input class="form-control" type="file" asp-for="Files" multiple />
    </div>

    <div class="form-check mb-3">
        <input class="form-check-input" asp-for="ConsentPopia" />
        <label class="form-check-label" asp-for="ConsentPopia"></label>
        <span class="text-danger d-block" asp-validation-for="ConsentPopia"></span>
    </div>

    <div class="d-flex gap-2">
        <button id="submitBtn" type="submit" class="btn btn-primary">Submit</button>
        <a asp-controller="Dashboard" asp-action="Index" class="btn btn-outline-secondary">Cancel</a>
    </div>
</form>

<!-- overlay animation -->
<div id="overlay" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-25 d-none"
     style="z-index: 1050;">
    <div class="position-absolute top-50 start-50 translate-middle text-center">
        <div class="spinner-border" role="status" style="width:3rem;height:3rem;"></div>
        <div class="mt-3 fw-semibold">Submitting…</div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // data from server
        const SUBMAP = @Html.Raw(subMapJson);

        const catSel  = document.getElementById('Category');
        const subSel  = document.getElementById('Subcategory');
        const otherTb = document.getElementById('OtherCategory');

        function populateSubs() {
            const cat = catSel.value;
            const options = SUBMAP[cat] || [];
            subSel.innerHTML = '<option value="">-- Select subcategory --</option>';
            for (const s of options) {
                const opt = document.createElement('option');
                opt.value = s; opt.textContent = s;
                subSel.appendChild(opt);
            }
            const isOther = (cat === 'Other');
            otherTb.disabled = !isOther;
            if (!isOther) { otherTb.value = ''; }
        }

        catSel.addEventListener('change', populateSubs);
        window.addEventListener('DOMContentLoaded', populateSubs);

        // pre-submit animation
        const form = document.getElementById('issueForm');
        form.addEventListener('submit', () => {
            document.getElementById('overlay').classList.remove('d-none');
            document.getElementById('submitBtn').disabled = true;
        });
    </script>
}
